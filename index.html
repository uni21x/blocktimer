<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0c10">
  <title>Blocktimer</title>
  <style>
    :root {
      /* Palette (User 1:1) */
      --bg: #0b0c10;
      --surface: #10131c;
      --surface-hover: #1c2230;
      /* Slightly lighter than surface */
      --border: #20263a;
      --text: #eaf0ff;
      --text-muted: #8892b0;
      /* Derived matching muted tone */
      --primary: #1a2450;
      --primary-hover: #263368;
      --danger: #2a0f16;
      --danger-hover: #451522;
      --success: #0f2a1c;
      --warning: #2a1f0f;

      /* Spacing & Radius */
      --radius: 12px;
      --gap: 16px;

      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    .container {
      max-width: 1400px;
      /* Wider for desktop */
      margin: 0 auto;
      padding: 40px;
      /* More padding */
      display: grid;
      grid-template-columns: 400px 1fr;
      /* Wider sidebar */
      gap: 32px;
      align-items: start;
    }

    header {
      padding: 0 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      grid-column: 1 / -1;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    h2 {
      margin: 0 0 16px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Forms & Inputs */
    label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input,
    select,
    textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Buttons */
    button {
      cursor: pointer;
      border: 1px solid var(--border);
      /* Added border */
      background: var(--surface-hover);
      color: var(--text);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      background: var(--border);
      border-color: var(--text-muted);
    }

    button:active {
      transform: translateY(1px);
    }

    button.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary-hover);
    }

    button.primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    button.danger {
      background: var(--danger);
      color: #fafafa;
      border: 1px solid var(--danger-hover);
    }

    button.danger:hover {
      background: var(--danger-hover);
      color: white;
    }

    button.ghost {
      background: transparent;
      color: var(--text-muted);
      border-color: var(--border);
    }

    button.ghost:hover {
      color: var(--text);
      background: var(--surface-hover);
      border-color: var(--text-muted);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .spread {
      justify-content: space-between;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .item:hover {
      border-color: var(--surface-hover);
    }

    .item.running {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-hover);
      background: linear-gradient(to right, rgba(26, 36, 80, 0.4), var(--surface));
    }

    .item.running .item-title {
      color: white;
    }

    .item.done {
      opacity: 0.5;
      border-color: var(--success);
      background: rgba(15, 42, 28, 0.2);
    }

    .item.done .item-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }

    .item-title {
      font-weight: 600;
      font-size: 15px;
    }

    .item-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    /* Badges */
    .badge {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 99px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.todo {
      background: var(--surface-hover);
      color: var(--text-muted);
    }

    .badge.running {
      background: rgba(99, 102, 241, 0.15);
      color: #818cf8;
    }

    .badge.paused {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    .badge.done {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }

    /* Progress & Timer */
    .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--primary);
      width: 0%;
      transition: width 1s linear;
      z-index: 1;
    }

    .time-large {
      font-family: monospace;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    /* Utilities */
    .hr {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 13px;
      font-style: italic;
    }

    /* Toast / Messages */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      z-index: 100;
      transform: translateY(100px);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      opacity: 0;
    }

    #toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    /* Dialog/Modal */
    dialog {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(2px);
    }

    dialog h3 {
      margin-top: 0;
      font-size: 18px;
    }

    dialog .actions {
      margin-top: 24px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Actions icons */
    .icon-btn {
      padding: 6px;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
  </style>
</head>

<body>

  <div class="container">
    <header>
      <div>
        <h1>Blocktimer</h1>
        <div class="subtitle" id="todayLabel">Lade...</div>
      </div>
      <div class="row" style="gap:24px">
        <button id="langToggle" class="ghost" style="padding:4px 8px; font-size:12px">DE / EN</button>
        <label class="col" style="align-items:center; gap:8px; cursor:pointer;" id="lblNotify"
          title="Benachrichtigungen aktivieren">
          <input type="checkbox" id="notifyToggle" style="width:16px; height:16px; cursor:pointer;" />
          <span style="font-size:18px;">üîî</span>
        </label>
        <label class="col" style="align-items:center; gap:8px; cursor:pointer;" id="lblSound" title="Sound an/aus">
          <input type="checkbox" id="soundToggle" style="width:16px; height:16px; cursor:pointer;" />
          <span style="font-size:18px;">üîä</span>
        </label>
      </div>
    </header>

    <!-- Left Column: Templates -->
    <aside class="col">
      <section class="card">
        <div class="row spread" style="margin-bottom:12px;">
          <h2 id="lblTemplates">Templates</h2>
          <button class="primary" id="openTplModalBtn" style="padding:4px 8px; font-size:12px;">+ Neu</button>
        </div>

        <div id="tplList" class="list"></div>

        <div class="hr"></div>

        <div class="col">
          <button id="regenTodayBtn" class="danger" style="width:100%">Heute neu generieren</button>
          <div class="subtitle" id="lblRegenWarn" style="font-size:11px; text-align:center;">
            Warnung: √úberschreibt den heutigen Plan komplett.
          </div>
        </div>
      </section>

      <section class="card">
        <h2 id="lblData">Datenverwaltung</h2>
        <div class="row">
          <button id="exportBtn" class="ghost" style="flex:1">Export</button>
          <button id="importBtn" class="ghost" style="flex:1">Import</button>
        </div>
        <button id="wipeBtn" class="danger ghost" style="width:100%; margin-top:8px;">Alles zur√ºcksetzen</button>
        <input id="importFile" type="file" accept=".json" style="display:none;" />
      </section>
    </aside>

    <!-- Right Column: Today & History -->
    <main class="col">
      <section class="card">
        <div class="row spread">
          <h2 id="lblToday">Heute</h2>
          <div class="subtitle" id="summaryLabel">0/0 erledigt</div>
        </div>

        <div id="todayList" class="list"></div>
      </section>

      <section class="card">
        <h2 id="lblHistory">Verlauf (Letzte 7 Tage)</h2>
        <div id="historyList" class="list"></div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast">Nachricht</div>

  <!-- Template Modal -->
  <dialog id="tplModal">
    <h3 id="lblTplModalTitle">Template bearbeiten</h3>
    <form id="tplForm" method="dialog" class="col">
      <input type="hidden" id="tplId" />
      <div>
        <label id="lblTplName">Name</label>
        <input id="tplName" type="text" placeholder="z. B. Deep Work" required />
      </div>
      <div class="row">
        <div style="flex:1">
          <label id="lblTplDuration">Dauer (Min)</label>
          <input id="tplMinutes" type="number" value="25" min="1" required />
        </div>
        <div style="flex:1">
          <label id="lblTplReps">Wdh.</label>
          <input id="tplReps" type="number" value="1" min="1" required />
        </div>
      </div>
      <div class="actions">
        <button type="button" id="btnTplCancel" class="ghost"
          onclick="document.getElementById('tplModal').close()">Abbrechen</button>
        <button type="submit" id="btnTplSave" class="primary">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Confirm Modal -->
  <dialog id="confirmModal">
    <h3 id="confirmTitle">Best√§tigen</h3>
    <p id="confirmText" style="color:var(--text-muted); margin-bottom:24px;">Bist du sicher?</p>
    <div class="actions">
      <button class="ghost" id="confirmCancel">Abbrechen</button>
      <button class="danger" id="confirmOk">Best√§tigen</button>
    </div>
  </dialog>

  <script>
    (() => {
      // --- Constants & State ---
      const K_TPL = "bt.templates.v1";
      const K_DAYS = "bt.days.v1";
      const K_CFG = "bt.cfg.v1";

      // Translations
      const translations = {
        de: {
          // Static
          templates: "Templates",
          new: "+ Neu",
          regen: "Tagesplan generieren",
          regenWarn: "Warnung: √úberschreibt den heutigen Plan komplett.",
          data: "Datenverwaltung",
          export: "Export",
          import: "Import",
          wipe: "Alles zur√ºcksetzen",
          today: "Heute",
          history: "Verlauf (Letzte 7 Tage)",
          notifyTitle: "Benachrichtigungen aktivieren",
          soundTitle: "Sound an/aus",

          // Modals
          tplModalTitle: "Template bearbeiten",
          name: "Name",
          placeholder: "z. B. Deep Work",
          duration: "Dauer (Min)",
          reps: "Wdh.",
          cancel: "Abbrechen",
          save: "Speichern",
          confirmTitle: "Best√§tigen",
          confirmText: "Bist du sicher?",
          confirmOk: "Best√§tigen",

          // Dynamic / JS
          emptyTpl: "Keine Templates. Erstelle dein erstes!",
          addSingle: "+ Einmalig zu heute hinzuf√ºgen",
          delTplTitle: "Template l√∂schen?",
          delTplText: (name) => `M√∂chtest du "${name}" wirklich l√∂schen?`,
          tplDeleted: "Template gel√∂scht",
          addedToToday: "Zu heute hinzugef√ºgt",

          emptyToday: "Heute steht nichts an. Generiere aus Templates oder f√ºge einzelne hinzu.",
          done: "erledigt",
          running: "l√§uft",

          badgeTodo: "Offen",
          badgeRunning: "L√§uft",
          badgePaused: "Pause",
          badgeDone: "Fertig",

          btnMarkDone: "Als erledigt markieren",
          btnReset: "Reset",
          btnStart: "Start",
          btnPause: "Pause",

          onlyOne: "Nur ein Timer gleichzeitig!",
          blockFinished: "Block beendet!",
          blockFinishedBody: (name) => `"${name}" ist fertig.`,

          wipeTitle: "Alles l√∂schen?",
          wipeText: "Wirklich ALLES l√∂schen?",
          exportStarted: "Export gestartet",
          importError: "Import fehlerhaft",
          emptyHistory: "Noch kein Verlauf.",
          resetLocked: (name) => `Erst '${name}' beenden oder zur√ºcksetzen!`,
          errTotalExceeded: "24h Limit erreicht! Tagesplan ist voll.",
          errBlockTooLong: "Block darf max. 24h lang sein.",
        },
        en: {
          templates: "Templates",
          new: "+ New",
          regen: "Generate Daily Plan",
          regenWarn: "Warning: Overwrites today's plan completely.",
          data: "Data Management",
          export: "Export",
          import: "Import",
          wipe: "Reset Everything",
          today: "Today",
          history: "History (Last 7 Days)",
          notifyTitle: "Enable Notifications",
          soundTitle: "Toggle Sound",

          tplModalTitle: "Edit Template",
          name: "Name",
          placeholder: "e.g. Deep Work",
          duration: "Duration (Min)",
          reps: "Reps",
          cancel: "Cancel",
          save: "Save",
          confirmTitle: "Confirm",
          confirmText: "Are you sure?",
          confirmOk: "Confirm",

          emptyTpl: "No templates. Create your first!",
          addSingle: "+ Add single block to today",
          delTplTitle: "Delete Template?",
          delTplText: (name) => `Really delete "${name}"?`,
          tplDeleted: "Template deleted",
          addedToToday: "Added to today",

          emptyToday: "Nothing planned. Generate from templates or add single blocks.",
          done: "done",
          running: "running",

          badgeTodo: "Todo",
          badgeRunning: "Running",
          badgePaused: "Paused",
          badgeDone: "Done",

          btnMarkDone: "Mark as done",
          btnReset: "Reset",
          btnStart: "Start",
          btnPause: "Pause",

          onlyOne: "Only one timer at a time!",
          blockFinished: "Block finished!",
          blockFinishedBody: (name) => `"${name}" is done.`,

          wipeTitle: "Delete everything?",
          wipeText: "Really delete EVERYTHING?",
          exportStarted: "Export started",
          importError: "Import failed",
          emptyHistory: "No history yet.",
          resetLocked: (name) => `Finish or reset '${name}' first!`,
          errTotalExceeded: "24h limit reached! Day plan is full.",
          errBlockTooLong: "Block max duration is 24h.",
        }
      };

      // Elements
      const $ = (id) => document.getElementById(id);

      // State
      let templates = [];
      let days = {};
      let cfg = { sound: true, notifications: false, lang: "de" }; // Default lang
      let audioCtx = null;

      // --- Helpers ---
      const t = (key, ...args) => {
        const val = translations[cfg.lang][key];
        if (typeof val === "function") return val(...args);
        return val || key;
      };

      // --- Helpers ---
      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
      const pad = (n) => String(n).padStart(2, "0");
      const dateKey = (d = new Date()) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

      const formatDate = (d) => new Date(d).toLocaleDateString(cfg.lang === "de" ? "de-DE" : "en-US", { weekday: "short", day: "numeric", month: "long" });
      const formatTime = (ms) => {
        if (!ms || ms < 0) return "00:00";
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        if (m >= 60) {
          const h = Math.floor(m / 60);
          return `${h}:${pad(m % 60)}:${pad(sec)}`;
        }
        return `${pad(m)}:${pad(sec)}`;
      };

      const formatDuration = (min) => {
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h}h${m > 0 ? ` ${m}m` : ''}`;
      };

      // --- Storage ---
      const load = () => {
        try {
          templates = JSON.parse(localStorage.getItem(K_TPL)) || [];
          days = JSON.parse(localStorage.getItem(K_DAYS)) || {};
          cfg = { ...cfg, ...JSON.parse(localStorage.getItem(K_CFG) || "{}") };
        } catch (e) { console.error("Load error", e); }
      };
      const save = () => {
        localStorage.setItem(K_TPL, JSON.stringify(templates));
        localStorage.setItem(K_DAYS, JSON.stringify(days));
        localStorage.setItem(K_CFG, JSON.stringify(cfg));
      };

      // --- Toast & Modal ---
      const toast = (msg, duration = 3000) => {
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("visible");
        setTimeout(() => t.classList.remove("visible"), duration);
      };

      const confirmDialog = (title, text, onOk) => {
        const d = $("confirmModal");
        $("confirmTitle").textContent = title;
        $("confirmText").textContent = text;

        // Cleanup old listeners
        const okBtn = $("confirmOk");
        const cancelBtn = $("confirmCancel");
        const newOk = okBtn.cloneNode(true);
        const newCancel = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOk, okBtn);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        newOk.onclick = () => { d.close(); onOk(); };
        newCancel.onclick = () => d.close();

        d.showModal();
      };

      // --- Audio & Notifications ---
      const beep = () => {
        if (!cfg.sound) return;
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = 880;
          g.gain.value = 0.05;
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start();
          setTimeout(() => o.stop(), 200);
        } catch (e) { }
      };

      const notify = (title, body) => {
        if (cfg.notifications && Notification.permission === "granted") {
          new Notification(title, { body, icon: "" }); // icon could be added
        }
        beep();
      };

      const requestNotify = async () => {
        if (!("Notification" in window)) return;
        if (Notification.permission === "default") {
          await Notification.requestPermission();
        }
      };

      // --- Logic ---
      const ensureToday = (force = false) => {
        const dk = dateKey();
        if (!days[dk] || force) {
          const tasks = [];

          // Validate Total Time for Display Warning (soft check)
          let totalMin = 0;
          templates.forEach(t => totalMin += (Number(t.minutes) * Number(t.reps || 1)));
          if (totalMin > 1440) setTimeout(() => toast(t("errTotalExceeded")), 500);

          templates.forEach(t => {
            const reps = Math.max(1, Number(t.reps || 1)); // Removed max 10 limit
            const grp = uid();
            for (let i = 1; i <= reps; i++) {
              tasks.push({
                id: uid(),
                groupId: grp,
                repIdx: i,
                name: t.name + (reps > 1 ? ` (${i}/${reps})` : ""),
                minutes: Number(t.minutes),
                status: "todo",
                startedAt: null, endsAt: null, remainingMs: null, completedAt: null, duration: Number(t.minutes) * 60000
              });
            }
          });
          days[dk] = { tasks, createdAt: Date.now() };
          save();
        }
      };

      const getToday = () => days[dateKey()]?.tasks || [];
      const setToday = (tasks) => {
        const dk = dateKey();
        if (!days[dk]) days[dk] = { createdAt: Date.now(), tasks: [] };
        days[dk].tasks = tasks;
        save();
      };

      // --- Render ---
      const renderLanguage = () => {
        // Toggle Button
        $("langToggle").textContent = cfg.lang.toUpperCase();

        // Static Text
        $("lblTemplates").textContent = t("templates");
        $("openTplModalBtn").textContent = t("new");
        $("regenTodayBtn").textContent = t("regen");
        $("lblRegenWarn").textContent = t("regenWarn");
        $("lblData").textContent = t("data");
        $("exportBtn").textContent = t("export");
        $("importBtn").textContent = t("import");
        $("wipeBtn").textContent = t("wipe");
        $("lblToday").textContent = t("today");
        $("lblHistory").textContent = t("history");

        // Header Toggles
        $("lblNotify").title = t("notifyTitle");
        $("lblSound").title = t("soundTitle");

        // Modals
        $("lblTplModalTitle").textContent = t("tplModalTitle");
        $("lblTplName").textContent = t("name");
        $("tplName").placeholder = t("placeholder");
        $("lblTplDuration").textContent = t("duration");
        $("lblTplReps").textContent = t("reps");
        $("btnTplCancel").textContent = t("cancel");
        $("btnTplSave").textContent = t("save");

        $("confirmTitle").textContent = t("confirmTitle");
        $("confirmText").textContent = t("confirmText");
        $("confirmOk").textContent = t("confirmOk");
        $("confirmCancel").textContent = t("cancel");
      };

      const renderTemplates = () => {
        const list = $("tplList");
        list.innerHTML = "";

        // Calculate Total
        const total = templates.reduce((acc, t) => acc + (t.minutes * (t.reps || 1)), 0);
        $("lblTemplates").textContent = `${t("templates")} (${formatDuration(total)})`;

        const newBtn = $("openTplModalBtn");
        if (total >= 1440) {
          newBtn.disabled = true;
          newBtn.title = t("errTotalExceeded");
        } else {
          newBtn.disabled = false;
          newBtn.title = "";
        }

        if (!templates.length) return list.innerHTML = `<div class="empty-state">${t("emptyTpl")}</div>`;

        templates.forEach(tobj => {
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
        <div class="item-header">
          <div class="item-title">${tobj.name}</div>
          <div class="row" style="gap:4px">
            <button class="icon-btn edit-btn">‚úèÔ∏è</button>
            <button class="icon-btn del-btn" style="color:var(--danger)">üóëÔ∏è</button>
          </div>
        </div>
        <div class="item-meta">
          <span>‚è± ${tobj.minutes} Min</span>
          <span>‚Üª ${tobj.reps}x</span>
        </div>
        <div style="margin-top:12px">
            <button class="ghost add-single-btn" style="font-size:11px; width:100%">${t("addSingle")}</button>
        </div>
      `;

          // Events
          el.querySelector(".del-btn").onclick = () => {
            confirmDialog(t("delTplTitle"), t("delTplText", tobj.name), () => {
              templates = templates.filter(x => x.id !== tobj.id);
              save();
              renderTemplates();
              toast(t("tplDeleted"));
            });
          };
          el.querySelector(".edit-btn").onclick = () => openTplModal(tobj);
          el.querySelector(".add-single-btn").onclick = () => {
            const tasks = getToday();
            // Check limit
            const currentTotal = tasks.reduce((acc, t) => acc + (t.duration / 60000), 0);
            const newBlock = Number(tobj.minutes);

            if (currentTotal + newBlock > 1440) {
              return toast(t("errTotalExceeded"));
            }

            tasks.push({
              id: uid(),
              name: tobj.name,
              minutes: Number(tobj.minutes),
              status: "todo",
              startedAt: null, endsAt: null, remainingMs: null, completedAt: null, duration: Number(tobj.minutes) * 60000
            });
            setToday(tasks);
            renderToday();
            toast(t("addedToToday"));
          };

          list.appendChild(el);
        });
      };

      const renderToday = () => {
        const tasks = getToday();
        const list = $("todayList");

        // Update Header Summary
        const doneCount = tasks.filter(t => t.status === "done").length;
        const runningCount = tasks.filter(t => t.status === "running").length;
        const totalMin = Math.round(tasks.reduce((acc, t) => acc + (t.duration / 60000), 0));

        $("summaryLabel").textContent = `${doneCount}/${tasks.length} ${t("done")}` +
          (runningCount ? ` ‚Ä¢ ${runningCount} ${t("running")}` : "") +
          ` ‚Ä¢ ${formatDuration(totalMin)}`;

        // Render List
        list.innerHTML = "";
        if (!tasks.length) return list.innerHTML = `<div class="empty-state">${t("emptyToday")}</div>`;

        // Smart Sort for Display
        const sortedTasks = tasks
          .map((t, i) => ({ t, i })) // Keep index
          .sort((a, b) => {
            // 1. Running -> Top
            if (a.t.status === "running" && b.t.status !== "running") return -1;
            if (a.t.status !== "running" && b.t.status === "running") return 1;

            // 2. Done -> Bottom
            if (a.t.status === "done" && b.t.status !== "done") return 1;
            if (a.t.status !== "done" && b.t.status === "done") return -1;

            // 3. Original Index (Flow)
            return a.i - b.i;
          })
          .map(x => x.t);

        sortedTasks.forEach(tobj => {
          const el = document.createElement("div");
          el.className = `item ${tobj.status}`;

          let badge = "todo", badgeText = t("badgeTodo"), timeLeft = "", progress = 0;
          let isLocked = false;

          // Check Sequential Lock (Forward)
          if (tobj.groupId && tobj.repIdx > 1) {
            const prev = tasks.find(x => x.groupId === tobj.groupId && x.repIdx === tobj.repIdx - 1);
            if (prev && prev.status !== "done") isLocked = true;
          }

          // Check Reverse Lock (Successor Active?)
          let isRevLocked = false;
          let successorName = "";
          if (tobj.groupId && tobj.status === "done") {
            const next = tasks.find(x => x.groupId === tobj.groupId && x.repIdx === tobj.repIdx + 1);
            if (next && next.status !== "todo") {
              isRevLocked = true;
              successorName = next.name;
            }
          }

          if (tobj.status === "running") {
            badge = "running"; badgeText = t("badgeRunning");
            const left = Math.max(0, tobj.endsAt - Date.now());
            timeLeft = formatTime(left);
            progress = 100 - (left / tobj.duration * 100);
          } else if (tobj.status === "paused") {
            badge = "paused"; badgeText = t("badgePaused");
            timeLeft = formatTime(tobj.remainingMs);
            progress = 100 - (tobj.remainingMs / tobj.duration * 100);
          } else if (tobj.status === "done") {
            badge = "done"; badgeText = t("badgeDone");
            progress = 100;
            timeLeft = new Date(tobj.completedAt).toLocaleTimeString(cfg.lang === "de" ? "de-DE" : "en-US", { hour: "2-digit", minute: "2-digit" });
          } else {
            // Todo: Show mm:ss instead of "25 Min" for consistency
            timeLeft = formatTime(tobj.minutes * 60000);
          }

          if (isLocked) {
            badge = "todo";
            badgeText = "üîí";
            el.style.opacity = "0.5";
          }

          el.innerHTML = `
        <div class="progress-bar" id="bar-${tobj.id}" style="width:${progress}%"></div>
        <div class="item-header">
          <div class="item-title">${tobj.name}</div>
          <span class="badge ${badge}">${badgeText}</span>
        </div>
        <div class="item-meta spread">
          <span class="time-large" id="time-${tobj.id}">${timeLeft}</span>
          <div class="row" style="gap:8px">
             ${tobj.status === "running" ? `<button class="primary pause-btn" title="${t("btnPause")}">‚è∏</button>` : ""}
             ${(tobj.status === "paused" || tobj.status === "todo") ? `<button class="primary play-btn" title="${t("btnStart")}" ${isLocked ? "disabled" : ""}>‚ñ∂</button>` : ""}
             ${tobj.status !== "done" ? `<button class="ghost done-btn" title="${t("btnMarkDone")}" ${isLocked ? "disabled" : ""}>‚úì</button>` : ""}
             <button class="ghost undo-btn" 
               title="${isRevLocked ? t("resetLocked", successorName) : t("btnReset")}" 
               ${tobj.status === "todo" ? "disabled" : ""}
               style="${isRevLocked ? "opacity:0.5;" : ""}"
             >‚Ü∫</button>
          </div>
        </div>
      `;

          // Actions
          if (tobj.status === "running") el.querySelector(".pause-btn").onclick = () => {
            tobj.status = "paused";
            tobj.remainingMs = tobj.endsAt - Date.now();
            tobj.endsAt = null;
            updateTask(tobj);
          };
          if (tobj.status === "paused" || tobj.status === "todo") el.querySelector(".play-btn").onclick = () => {
            if (getToday().some(x => x.status === "running")) return toast(t("onlyOne"));

            const isResuming = tobj.status === "paused" && tobj.remainingMs > 0;
            const ms = isResuming ? tobj.remainingMs : (tobj.minutes * 60000);

            tobj.status = "running";
            tobj.duration = tobj.duration || ms; // ensure duration is set
            tobj.endsAt = Date.now() + ms;
            tobj.startedAt = tobj.startedAt || Date.now();
            tobj.remainingMs = null;
            updateTask(tobj);
            beep();
          };
          if (tobj.status !== "done") el.querySelector(".done-btn").onclick = () => {
            tobj.status = "done";
            tobj.completedAt = Date.now();
            tobj.endsAt = null;
            updateTask(tobj);
          };
          if (true) el.querySelector(".undo-btn").onclick = () => {
            if (tobj.status === "todo" || isRevLocked) return;
            tobj.status = "todo";
            tobj.endsAt = null;
            tobj.remainingMs = null;
            tobj.completedAt = null;
            updateTask(tobj);
          };

          list.appendChild(el);
        });
      };

      const updateTask = (t) => {
        const tasks = getToday();
        const idx = tasks.findIndex(x => x.id === t.id);
        if (idx >= 0) tasks[idx] = t;
        setToday(tasks);
        renderToday();
      };

      const renderHistory = () => {
        const list = $("historyList");
        list.innerHTML = "";

        // Sort keys desc
        const keys = Object.keys(days).sort().reverse();
        // Exclude today
        const pastKeys = keys.filter(k => k !== dateKey()).slice(0, 7);

        if (!pastKeys.length) return list.innerHTML = `<div class="empty-state">${t("emptyHistory")}</div>`;

        pastKeys.forEach(k => {
          const day = days[k];
          const done = day.tasks.filter(t => t.status === "done").length;
          const total = day.tasks.length;

          const el = document.createElement("div");
          el.className = "item";
          el.style.padding = "10px 14px";
          el.innerHTML = `
        <div class="row spread">
          <strong>${formatDate(k)}</strong>
          <span class="badge ${done === total ? 'done' : 'todo'}">${done}/${total}</span>
        </div>
      `;
          list.appendChild(el);
        });
      };



      $("tplForm").onsubmit = (e) => {
        // e.preventDefault() handled by dialog method="dialog" but we need to guard
        const data = {
          id: $("tplId").value || uid(),
          name: $("tplName").value,
          minutes: Number($("tplMinutes").value),
          reps: Number($("tplReps").value)
        };

        // Check 24h limit for single block config
        if (data.minutes * data.reps > 1440) {
          return toast(t("errBlockTooLong"));
        }

        // Check if TOTAL templates duration exceeds 24h
        let currentTotal = 0;
        templates.forEach(t => {
          if ($("tplId").value && t.id === $("tplId").value) return; // Ignore self if editing
          currentTotal += (t.minutes * (t.reps || 1));
        });

        if (currentTotal + (data.minutes * data.reps) > 1440) {
          return toast(t("errTotalExceeded"));
        }

        if ($("tplId").value) {
          // Edit
          const idx = templates.findIndex(t => t.id === data.id);
          if (idx >= 0) templates[idx] = data;
        } else {
          // New
          templates.push(data);
        }
        save();
        renderTemplates();
        toast(t("save"));
      };

      const validateTpl = () => {
        const min = Number($("tplMinutes").value) || 0;
        const reps = Number($("tplReps").value) || 0;
        const currentBlock = min * reps;
        const saveBtn = $("btnTplSave");

        // 1. Single block limit
        if (currentBlock > 1440) {
          saveBtn.disabled = true;
          saveBtn.title = t("errBlockTooLong");
          return;
        }

        // 2. Total limit
        let otherTotal = 0;
        const id = $("tplId").value;
        templates.forEach(t => {
          if (id && t.id === id) return;
          otherTotal += (t.minutes * (t.reps || 1));
        });

        if (otherTotal + currentBlock > 1440) {
          saveBtn.disabled = true;
          saveBtn.title = t("errTotalExceeded");
          return;
        }

        saveBtn.disabled = false;
        saveBtn.title = "";
      };

      $("tplMinutes").oninput = validateTpl;
      $("tplReps").oninput = validateTpl;

      const openTplModal = (tpl = null) => {
        $("tplId").value = tpl ? tpl.id : "";
        $("tplName").value = tpl ? tpl.name : "";
        $("tplMinutes").value = tpl ? tpl.minutes : 25;
        $("tplReps").value = tpl ? tpl.reps : 1;
        validateTpl(); // Validate initial state
        $("tplModal").showModal();
      };

      $("openTplModalBtn").onclick = () => openTplModal();

      $("regenTodayBtn").onclick = () => {
        confirmDialog(t("regen"), t("regenWarn"), () => {
          ensureToday(true);
          renderToday();
          toast(t("regen"));
        });
      };

      // --- Global Toggles ---
      $("soundToggle").onchange = (e) => {
        cfg.sound = e.target.checked;
        save();
      };
      $("notifyToggle").onchange = (e) => {
        cfg.notifications = e.target.checked;
        save();
        if (cfg.notifications) requestNotify();
      };

      $("langToggle").onclick = () => {
        cfg.lang = cfg.lang === "de" ? "en" : "de";
        save();
        location.reload();
      };

      // --- Import/Export ---
      $("wipeBtn").onclick = () => confirmDialog(t("wipeTitle"), t("wipeText"), () => {
        localStorage.clear();
        location.reload();
      });

      $("exportBtn").onclick = () => {
        const data = JSON.stringify({ templates, days, cfg });
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `blocktimer-${dateKey()}.json`;
        a.click();
        toast(t("exportStarted"));
      };

      $("importBtn").onclick = () => $("importFile").click();
      $("importFile").onchange = async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        try {
          const text = await f.text();
          const json = JSON.parse(text);
          if (json.templates) templates = json.templates;
          if (json.days) days = json.days;
          if (json.cfg) cfg = json.cfg;
          save();
          location.reload();
        } catch (err) {
          toast(t("importError"));
        }
      };

      // --- Loop ---
      const tick = () => {
        const now = Date.now();
        const tasks = getToday();
        let changed = false;
        const running = tasks.find(t => t.status === "running");

        if (running) {
          // Check finish
          if (now >= running.endsAt) {
            running.status = "done";
            running.completedAt = now;
            running.endsAt = null;
            changed = true;
            notify(t("blockFinished"), t("blockFinishedBody", running.name));
          } else {
            // Update Title
            const m = Math.ceil((running.endsAt - now) / 60000);
            document.title = `(${m}m) ${running.name}`;
          }
        } else {
          document.title = "Blocktimer";
        }

        if (changed) {
          setToday(tasks);
          renderToday();
        } else if (running) {
          updateRunningUI(running);
        }
      };

      // --- Init ---
      load();
      ensureToday();

      renderLanguage(); // Initial render of static text

      $("soundToggle").checked = !!cfg.sound;
      $("notifyToggle").checked = !!cfg.notifications;
      $("todayLabel").textContent = formatDate(new Date());

      renderTemplates();
      renderToday();
      renderHistory();

      const updateRunningUI = (t) => {
        const left = Math.max(0, t.endsAt - Date.now());
        const timeStr = formatTime(left);

        document.title = `${timeStr} - ${t.name}`;

        const timeEl = document.getElementById(`time-${t.id}`);
        const barEl = document.getElementById(`bar-${t.id}`);

        if (timeEl) timeEl.textContent = timeStr;
        if (barEl) {
          const progress = 100 - (left / t.duration * 100);
          barEl.style.width = `${progress}%`;
        }
      };

      setInterval(tick, 1000);

    })();
  </script>
</body>

</html>